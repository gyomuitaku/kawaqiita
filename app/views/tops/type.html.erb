
<body>
  <p id="text"></p>
  <p id="target">click to start</p>
  <p id="botan">
  </p>
    <%# <p><input id="next" type="button" value="next"class="botan"></p> %>
  <p class="info">
    正解問題数: <span id="score">0</span>,
    残り問題数: <span id="total">10</span>,

    問題数: <span id="time">10</span>
    <table class='data-table'>
      <tr><th>英語</th><th>日本語</th></tr>
    </table> 

    
    <%# <table class="table" id="answer"></table> %>
    <table class="data-table">
      <tr><th>英語</th><th>日本語</th></tr>
    </table>
  </p>

  
  </body>


<script>
{
  // const words = gon.questions;
  const words = gon.questions;
  let word;
  let cnt;
  let loc;
  let score;
  let miss;
  let plusword;
  let apple;
  let isPlaying = false;
  let total_count;
  let list;
  const target = document.getElementById('target');
  const text = document.getElementById('text');

  const scoreLabel = document.getElementById('score');
  const missLabel = document.getElementById('miss');
  // const timerLabel = document.getElementById('timer');

  const total = document.getElementById("total")

  const table = document.getElementById('tab');
  const answer = document.getElementById('answer');

  let tables= document.getElementsByClassName('data-table');
  // 現在の display プロパティの値を保持
  const displayOriginal = tables[0].style.display;
  const displayOrigina = tables[1].style.display;
// none に設定して非表示
  tables[0].style.display = 'none';
  tables[1].style.display = 'none';
  function tr_create(wor,x) {
    for (var i = 0; i < wor.length; i++) {
  // テーブルの行を 5行追加する
    var tr = document.createElement('tr');
    for (var j = 0; j < 2; j++) {
      var td = document.createElement('td');
    // テーブルの列を 3行追加する
    if (j===0) {
      td.innerHTML = wor[i][0];
    }
    else if(j===1){
      td.innerHTML = wor[i][1];
    }
    tr.appendChild(td);
  }
  tables[x].appendChild(tr);
  }  
  }

  // 要素を取得
  // let data_table = document.getElementById('data-table');





  function updateTarget() {
    let placeholder = '';
    for (let i = cnt; i > 0; i--) {
      placeholder += '_';
    }
    text.textContent = word[1]
    target.textContent = plusword + placeholder ;
  }

  function for_base(para) {
    let loc=[];
    for(let i= 0;i<para.length;i++){
      loc.push(para[i])
    }
    return loc
  }
  function updateTimer() {

    if (total_count <= 0) {
      isPlaying = true;

      target.textContent = 'F I N I S H';
      total.textContent = total_count;
      text.textContent ="";
      
      removebotan()
      gameEnd()
      // 元に戻して表示
      tables[0].style.display = displayOriginal;
      tables[1].style.display = displayOriginal;
      // data-table.style.display = displayOriginal;
      tr_create(for_base(apple),0)
      tr_create(for_base(list),1)
      
    }
  }
  function createbotan(params,parama) {
    const bota ="bottan";
    let botans;
    botans =bota +`${params}`
    botans =document.getElementById("botan");
    if (botans.hasChildNodes()){
      const input = document.createElement("input");
      input.setAttribute("type","button"); 
		  input.setAttribute("size","50"); 
      input.setAttribute("id",parama)
		  input.setAttribute("value",parama);
      botans.appendChild(input);
    }
    
  }
  function removebotan() {
    const botan = document.getElementById("botan");
	  if (botan.hasChildNodes()){
		while (botan.firstChild) {
      botan.removeChild(botan.firstChild);
    }
    
  }}

  function showResult() {
    const accuracy = score  === 0 ? 0 : score / (score ) * 100;
    alert("${score} letters, ${miss} misses, ${accuracy.toFixed(2)}% accuracy!");
  }
  function plus(lists,word) {
    lists.push(word)
  }


  function gameEnd() {
    let appai =[]
    let miss =[]
    for (let i=0;i<apple.length;i++){
       appai =apple[i]
      $.ajax({
        url: '/type/results',
        type: 'POST',
        data: {
          results: appai
        }
      })
    }
    for (let i=0;i<list.length;i++){
       miss =list[i]
      $.ajax({
        url: '/type/results',
        type: 'POST',
        data: {
          miss: miss
        }
      })
    }

  }

  window.addEventListener('click', () => {
    if (isPlaying === true) {
      return;
    }
    isPlaying = true;
    createbotan("1","next")
    createbotan("2","reset")
    loc = 0;
    score = 0;
    miss = 0;
    cnt =0;
    total_count =10;
    plusword ="";
    apple =[]
    list =[]
    scoreLabel.textContent = score;
    word = words[Math.floor(Math.random() * words.length)];
    
    total.textContent = total_count;
    cnt =word[0].length;
    
    updateTarget()
    if (isPlaying!==false){
    if (!next.hasChildNodes()){
          next.addEventListener("click", function (e) {
            plus(list,word)
            word = words[Math.floor(Math.random() * words.length)];
            plusword =""
            total_count --;
            total.textContent = total_count;
            cnt =word[0].length;
            // plus(apple,word);
            
            updateTarget();
            updateTimer();
        })
     }
    }
    if (!reset.hasChildNodes()){
      reset.addEventListener("click", function (e) {
    // timerLabel.textContent = "";
        text.textContent ="";
        target.textContent=""
        alert("処理が終了されますがよろしいですか");
        window.location.reload();
      })
    }
  });

  window.addEventListener('keydown', e => {
    if (isPlaying !== true) {
      return;
    }
    if (e.key === word[0][loc]) {
      loc++;
      cnt --;
      plusword +=word[0][loc-1]
      if (loc === word[0].length) {
        plus(apple,word)
        word = words[Math.floor(Math.random() * words.length)];
        total_count --;
        total.textContent = total_count;
        
        loc = 0;
        cnt = word[0].length;
        plusword ="";
        score++;
        scoreLabel.textContent = score;
      }
      updateTarget();
      updateTimer()
    }
  });
  
}
// </script>
<style>
body {
  padding-top: 40px;
  font-family: 'Courier New', monospace;
  text-align: center;
}

#target {
  font-size: 48px;
  letter-spacing: 3px;
}
</style>
